<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>天气小宠 · 专属陪伴</title>
    <meta name="description" content="专属陪伴的3D天气小宠物">
    <meta name="theme-color" content="#5a9bd5">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/icons/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icons/icon.svg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="小宠">
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, 'Helvetica Neue', 'Segoe UI', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #e8f4f8 0%, #d4e9f0 100%);
        }
        
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #info-panel {
            position: absolute;
            bottom: 40px;
            left: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 28px;
            padding: 28px;
            box-shadow: 0 12px 40px rgba(100, 150, 180, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        #weather-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #5a9bd5, #4a8bc5);
            color: white;
            padding: 8px 18px;
            border-radius: 24px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(74, 139, 197, 0.3);
        }
        
        #message-bubble {
            font-size: 1.2rem;
            font-weight: 500;
            line-height: 1.6;
            color: #3a4a5a;
            margin-bottom: 20px;
            word-break: break-word;
            min-height: 3.5rem;
            letter-spacing: 0.3px;
        }
        
        .stats-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }
        
        .happiness-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #7a8a9a;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .bar-bg {
            flex: 1;
            height: 10px;
            background: #e0e8f0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .bar-fill {
            height: 100%;
            width: 60%;
            background: linear-gradient(90deg, #5a9bd5, #3d7ab8);
            border-radius: 12px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hint-icons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(200, 220, 240, 0.4);
        }
        
        .hint-icons span {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            color: #8a9aa8;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .hint-icons i {
            font-size: 1.3rem;
            color: #5a9bd5;
        }
        
        #night-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(20, 30, 45, 0.4);
            pointer-events: none;
            z-index: 5;
            opacity: 0;
            transition: opacity 1s ease;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #4a8bc5;
            font-size: 1rem;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.95);
            padding: 18px 32px;
            border-radius: 32px;
            backdrop-filter: blur(10px);
            z-index: 20;
            box-shadow: 0 10px 40px rgba(100, 150, 180, 0.2);
        }
        
        #permission-guide {
            position: absolute;
            bottom: 180px;
            left: 24px;
            right: 24px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 24px;
            border-radius: 24px;
            text-align: center;
            backdrop-filter: blur(10px);
            z-index: 30;
            display: none;
        }
        
        #request-permission-btn {
            background: linear-gradient(135deg, #5a9bd5, #4a8bc5);
            border: none;
            padding: 12px 32px;
            border-radius: 28px;
            margin-top: 12px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 0.95rem;
        }
        
        #request-permission-btn:active {
            transform: scale(0.95);
        }
        
        .love-popup {
            position: absolute;
            color: #4a8bc5;
            font-weight: 700;
            font-size: 1.2rem;
            pointer-events: none;
            animation: floatUp 1.5s ease-out forwards;
            z-index: 100;
            text-shadow: 0 2px 4px rgba(74, 139, 197, 0.3);
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(1.2);
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="loading">✨ 正在唤醒小宠...</div>
    <div id="night-overlay"></div>
    <div id="canvas-container"></div>
    
    <div id="info-panel">
        <div id="weather-tag"><i class="fas fa-sun"></i> 加载天气中...</div>
        <div id="message-bubble">hey，点我一下，有惊喜给你～</div>
        <div class="stats-bar">
            <span class="happiness-label">
                <i class="fas fa-heart" style="color: #4a8bc5;"></i>
                亲密度
            </span>
            <div class="bar-bg"><div class="bar-fill" id="happiness-fill" style="width:60%"></div></div>
            <span id="happiness-value" style="color:#4a8bc5; font-weight:600; font-size:0.9rem;">60</span>
        </div>
        <div class="hint-icons">
            <span><i class="fas fa-hand-pointer"></i>点击互动</span>
            <span><i class="fas fa-mobile-alt"></i>摇晃手机</span>
            <span><i class="fas fa-bolt"></i>充电加速</span>
            <span><i class="fas fa-moon"></i>夜间安睡</span>
        </div>
    </div>

    <div id="permission-guide">
        <i class="fas fa-bell" style="font-size: 2rem; margin-bottom: 8px; color: #5a9bd5;"></i>
        <p style="font-size: 1rem; margin-bottom: 4px;">开启通知，让我随时陪伴你</p>
        <button id="request-permission-btn">允许通知</button>
    </div>

    <script type="module">
        import * as THREE from 'three';

        // --- 配置和状态 ---
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        let pet = {
            happiness: 60,
            lastVisit: Date.now(),
            weather: '晴',
            lastInteraction: Date.now(),
            messageCount: 0  // 记录消息次数，用于每5句插入天气情话
        };

        // 加载本地存储
        try {
            const saved = localStorage.getItem('weatherPet3d_v2');
            if (saved) {
                const loaded = JSON.parse(saved);
                const lastTime = loaded.lastVisit || Date.now();
                const hoursPassed = Math.floor((Date.now() - lastTime) / (1000 * 60 * 60));
                
                // 每小时掉5点好感度，但初始保持60
                pet.happiness = Math.max(0, Math.min(60, (loaded.happiness || 60) - hoursPassed * 5));
                pet.lastVisit = lastTime;
                pet.lastInteraction = loaded.lastInteraction || Date.now();
                pet.messageCount = loaded.messageCount || 0;
            }
        } catch (e) {}

        // --- 100条情话数据库（60分以上分级，每5句插入天气情话） ---
        const loveMessages = {
            // 60-69分：温柔守护（1-20）
            level60: [
                '有我在，你什么都不用怕。',
                '遇见你之后，我想成为更好的人。',
                '我不想和别人暧昧，只想和你认真。',
                '你不用完美，我喜欢就好。',
                '一想到你，我就充满动力。',
                '世界再大，我的眼里只有你。',
                '跟你在一起，平凡的日子也有光。',
                '你是我藏在心底的柔软。',
                '有你，人间值得。',
                '我所有的温柔，都留给你。',
                '你是我疲惫生活里的英雄梦想。',
                '只要是你，晚点也没关系。',
                '我想把所有好听的话，都说给你听。',
                '你是我最想留住的幸运。',
                '遇见你，是我这辈子最酷的事。',
                '我想和你，从心动到古稀。',
                '你在身边，在你身边，就是最好的。',
                '你不用逞强，我来保护你。',
                '我的满心欢喜，全都给了你。',
                '有你，风是暖的，心是满的。'
            ],
            // 70-79分：深情专一（21-40）
            level70: [
                '别人再好与我无关，你再普通我都喜欢。',
                '我对你，永远是明目张胆的偏爱。',
                '你是我唯一的执着，也是我的例外。',
                '比起一时的新鲜感，我更想要一直是你。',
                '我不想感动谁，只想守着一个你。',
                '我的温柔和耐心，只对你一个人。',
                '你是我明目张胆的喜欢，众所周知的偏爱。',
                '我不想错过你，也不想把你让给别人。',
                '你是我跑完八百米还想拥抱的人。',
                '我所有的温柔例外，全都偏向你。',
                '你是我坚定不移的选择。',
                '我不想和你暧昧，只想和你好好相爱。',
                '你是我这辈子最坚定的选择。',
                '我想把所有的偏爱，都给你一个人。',
                '别人再好，都与我无关。',
                '你是我一眼心动，也是万年情深。',
                '此生固短，无你何欢。',
                '我想把所有温柔，都藏起来留给你。',
                '我不想撞南墙，只想撞进你的心里。',
                '你是我藏在微风里的喜欢。'
            ],
            // 80-89分：浪漫直球（41-60）
            level80: [
                '见你第一眼，就知道我栽了。',
                '春风十里，不如你。',
                '山河远阔，人间烟火，无一是你，无一不是你。',
                '世界万般美好，都不及你一笑。',
                '你一笑，我连天空都忘了看。',
                '你是我藏在云层里的月亮，也是我穷其一生要找的宝藏。',
                '遇见你，凛冬散尽，星河长明。',
                '你是我疲惫时最想依靠的怀抱。',
                '闭上眼是你，睁开眼还是你。',
                '你是我所有的心事和未说出口的喜欢。',
                '你是我写过最美的情书。',
                '想把你藏进梦里，天亮也带不走你。',
                '你是我最想奔赴的未来。',
                '你是我平淡岁月里最耀眼的光。',
                '世间万物皆苦，你是明目张胆的甜。',
                '你是我藏在心底的爱意泛滥。',
                '遇见你之后，我再也没有羡慕过别人。',
                '你是我一生只会遇见一次的惊喜。',
                '你是我所有温柔的来源和归属。',
                '我想牵着你的手，从心动到白首。'
            ],
            // 90-99分：暖心可靠（61-80）
            level90: [
                '不管发生什么，我都在你身后。',
                '你可以随时找我，我永远都在。',
                '别怕，有我在。',
                '你不用逞强，我来扛。',
                '你负责开心，我负责爱你。',
                '累了就靠在我肩上，我一直都在。',
                '你是我最安心的归属感。',
                '有我在，你就不用长大。',
                '我想做你永远的避风港。',
                '你可以放心依赖我。',
                '不管你走多远，回头我都在。',
                '你的喜怒哀乐，我都愿意听。',
                '我想做你最靠谱的依靠。',
                '有我在，你就不用独自硬撑。',
                '你只管开心，别的交给我。',
                '你是我最想守护的人。',
                '我会一直陪着你，很久很久。',
                '你是我最踏实的心安。',
                '你的小脾气，我都包容。',
                '你不用完美，我来爱你就够了。'
            ],
            // 100分：余生承诺（81-100）
            level100: [
                '我想和你，一房两人，三餐四季。',
                '往后余生，风雪是你，平淡是你。',
                '我想和你，从校服到婚纱。',
                '这辈子，下辈子，下下辈子，我都要你。',
                '我不想和你只是一时，我想和你是一世。',
                '余生很长，想和你慢慢来。',
                '我不仅要你的现在，还要你的余生。',
                '我想和你一起，慢慢变老。',
                '此生唯一执念，唯有你。',
                '我想和你，把日子过成我们喜欢的样子。',
                '世界再大，有你就有家。',
                '我想和你走过岁岁年年。',
                '我想和你一起看遍世间所有风景。',
                '我的未来，每一个计划里都有你。',
                '你是我余生全部的期待。',
                '我想和你，不止在这个冬天，而是每一个四季。',
                '只要最后是你，过程多苦我都愿意。',
                '你是我一生只会遇见一次的惊喜。',
                '遇见你，爱意汹涌，看世间万物都浪漫心动。',
                '我爱你，不是一时兴起，而是一生决定。'
            ],
            // 天气情话（每5句插入一次）
            weather: {
                '晴': ['今天阳光很好，就像你的笑容一样温暖。', '晴天适合想你，更适合见你。', '阳光和你都在，这就是我想要的未来。'],
                '多云': ['不管天气怎样，我心里永远是晴天，因为有你。', '云朵遮不住我对你的想念，就像时间带不走我对你的喜欢。'],
                '雨': ['下雨了，记得带伞，别淋湿了，我会心疼。', '雨声淅淅沥沥，像我在你耳边说爱你。', '每滴雨都是我想你的频率。'],
                '雪': ['下雪了，想和你一起看雪，一起白头。', '雪花很美，但你比雪更美。', '想和你堆雪人，我当雪人你当我。'],
                '雾': ['雾再大，我也能找到你，因为你在我心里。', '朦胧的是天气，清晰的是我喜欢你。'],
                '夜': ['晚安，做个好梦，梦里有我。', '星星睡了，我还在想你。', '月亮代表我的心，但它没我专一。']
            },
            // 互动情话
            interact: {
                click: ['被你点到了，开心！', '再来一下嘛', '我就喜欢你这样', '嘿嘿，好痒', '你的手好温暖'],
                shake: ['哎呀，被你晃晕了', '再摇我就要散架啦', '晕晕乎乎的，满脑子都是你'],
                charge: ['充能中...你的笑容就是我的电量', '满血复活，继续陪你！', '能量满格，爱你加倍'],
                lowbat: ['我需要你的关注...', '快来陪陪我吧']
            }
        };

        // 获取情话（每5句插入天气情话）
        function getLoveMessage() {
            pet.messageCount++;
            
            // 每5句插入天气情话
            if (pet.messageCount % 5 === 0) {
                const weatherArr = loveMessages.weather[pet.weather] || loveMessages.weather['晴'];
                return weatherArr[Math.floor(Math.random() * weatherArr.length)];
            }
            
            // 根据亲密度选择情话
            let levelArr;
            if (pet.happiness >= 100) {
                levelArr = loveMessages.level100;
            } else if (pet.happiness >= 90) {
                levelArr = loveMessages.level90;
            } else if (pet.happiness >= 80) {
                levelArr = loveMessages.level80;
            } else if (pet.happiness >= 70) {
                levelArr = loveMessages.level70;
            } else {
                levelArr = loveMessages.level60;
            }
            
            return levelArr[Math.floor(Math.random() * levelArr.length)];
        }

        function getMessage(type, subType) {
            if (type === 'interact' && loveMessages.interact[subType]) {
                const arr = loveMessages.interact[subType];
                return arr[Math.floor(Math.random() * arr.length)];
            }
            return getLoveMessage();
        }

        // --- 初始化 Three.js 场景 ---
        const container = document.getElementById('canvas-container');
        
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f8ff);
        scene.fog = new THREE.Fog(0xf0f8ff, 10, 30);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 2.2, 5.5);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // 灯光系统
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xfff8e7, 1.0);
        dirLight.position.set(3, 5, 4);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 1024;
        dirLight.shadow.mapSize.height = 1024;
        dirLight.shadow.camera.near = 0.5;
        dirLight.shadow.camera.far = 20;
        dirLight.shadow.bias = -0.001;
        scene.add(dirLight);

        const fillLight = new THREE.DirectionalLight(0xd4e9f0, 0.4);
        fillLight.position.set(-3, 2, -2);
        scene.add(fillLight);

        // 地面
        const planeGeometry = new THREE.CircleGeometry(4, 64);
        const planeMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xe8f4f8, 
            roughness: 0.8,
            metalness: 0.1
        });
        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
        plane.rotation.x = -Math.PI / 2;
        plane.position.y = 0;
        plane.receiveShadow = true;
        scene.add(plane);

        // --- 构建阳光帅气男生3D形象（优化发型） ---
        const character = new THREE.Group();

        // 配色方案
        const skinMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xf5d0b0,
            roughness: 0.4,
            metalness: 0.1
        });
        
        const clothesMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x5a9bd5,
            roughness: 0.6,
            metalness: 0.1
        });
        
        const darkMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x2a2a2a,
            roughness: 0.3 
        });
        
        const whiteMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xffffff, 
            roughness: 0.2 
        });
        
        const hairMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x2d1f16,  // 深棕黑色
            roughness: 0.5,
            metalness: 0.1
        });
        
        const pantsMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x4a5a6a,
            roughness: 0.7 
        });

        // 1. 身体组
        const bodyGroup = new THREE.Group();
        
        // 躯干
        const torsoGeo = new THREE.CylinderGeometry(0.5, 0.5, 1.3, 16);
        const torso = new THREE.Mesh(torsoGeo, clothesMaterial);
        torso.position.y = 0.65;
        torso.castShadow = true;
        bodyGroup.add(torso);
        
        // 躯干顶部圆角
        const torsoTopGeo = new THREE.SphereGeometry(0.5, 16, 8, 0, Math.PI * 2, 0, Math.PI/2);
        const torsoTop = new THREE.Mesh(torsoTopGeo, clothesMaterial);
        torsoTop.position.y = 1.3;
        bodyGroup.add(torsoTop);
        
        // 躯干底部
        const torsoBottomGeo = new THREE.SphereGeometry(0.5, 16, 8, 0, Math.PI * 2, Math.PI/2, Math.PI/2);
        const torsoBottom = new THREE.Mesh(torsoBottomGeo, clothesMaterial);
        torsoBottom.position.y = 0;
        bodyGroup.add(torsoBottom);

        // 2. 头部组
        const headGroup = new THREE.Group();
        headGroup.position.y = 1.75;
        
        // 头型
        const headGeo = new THREE.SphereGeometry(0.48, 32, 32);
        headGeo.scale(0.95, 1.05, 0.95);
        const head = new THREE.Mesh(headGeo, skinMaterial);
        head.castShadow = true;
        headGroup.add(head);
        
        // ===== 优化发型：自然短发 =====
        // 头顶发型 - 稍微蓬松但整齐
        const hairTopGeo = new THREE.SphereGeometry(0.49, 32, 32, 0, Math.PI * 2, 0, Math.PI/2.5);
        const hairTop = new THREE.Mesh(hairTopGeo, hairMaterial);
        hairTop.position.y = 0.1;
        hairTop.scale.set(1.02, 0.85, 1.02);
        headGroup.add(hairTop);
        
        // 两侧短发 - 整齐修剪感
        const hairSideGeo = new THREE.CapsuleGeometry(0.08, 0.3, 4, 8);
        
        // 左侧头发
        const leftHair1 = new THREE.Mesh(hairSideGeo, hairMaterial);
        leftHair1.position.set(-0.45, 0.25, 0.2);
        leftHair1.rotation.z = 0.3;
        leftHair1.rotation.x = 0.2;
        headGroup.add(leftHair1);
        
        const leftHair2 = new THREE.Mesh(hairSideGeo, hairMaterial);
        leftHair2.position.set(-0.42, 0.15, 0.35);
        leftHair2.rotation.z = 0.2;
        leftHair2.rotation.x = 0.1;
        headGroup.add(leftHair2);
        
        // 右侧头发
        const rightHair1 = new THREE.Mesh(hairSideGeo, hairMaterial);
        rightHair1.position.set(0.45, 0.25, 0.2);
        rightHair1.rotation.z = -0.3;
        rightHair1.rotation.x = 0.2;
        headGroup.add(rightHair1);
        
        const rightHair2 = new THREE.Mesh(hairSideGeo, hairMaterial);
        rightHair2.position.set(0.42, 0.15, 0.35);
        rightHair2.rotation.z = -0.2;
        rightHair2.rotation.x = 0.1;
        headGroup.add(rightHair2);
        
        // 前额刘海 - 自然分开的碎发
        const bangGeo = new THREE.CapsuleGeometry(0.06, 0.25, 4, 8);
        
        for (let i = -1; i <= 1; i++) {
            const bang = new THREE.Mesh(bangGeo, hairMaterial);
            bang.position.set(i * 0.15, 0.35, 0.45);
            bang.rotation.x = -0.3;
            bang.rotation.z = i * 0.1;
            headGroup.add(bang);
        }
        
        // 后脑勺头发
        const backHairGeo = new THREE.SphereGeometry(0.47, 16, 16, 0, Math.PI * 2, Math.PI/2, Math.PI/3);
        const backHair = new THREE.Mesh(backHairGeo, hairMaterial);
        backHair.position.y = 0.05;
        backHair.position.z = -0.05;
        headGroup.add(backHair);

        // 眼睛
        const eyeGeo = new THREE.SphereGeometry(0.065, 16, 16);
        const leftEye = new THREE.Mesh(eyeGeo, darkMaterial);
        leftEye.position.set(-0.15, 0.05, 0.4);
        headGroup.add(leftEye);
        
        const rightEye = new THREE.Mesh(eyeGeo, darkMaterial);
        rightEye.position.set(0.15, 0.05, 0.4);
        headGroup.add(rightEye);
        
        // 眼睛高光
        const highlightGeo = new THREE.SphereGeometry(0.022, 8, 8);
        const leftHighlight = new THREE.Mesh(highlightGeo, whiteMaterial);
        leftHighlight.position.set(-0.17, 0.08, 0.45);
        headGroup.add(leftHighlight);
        
        const rightHighlight = new THREE.Mesh(highlightGeo, whiteMaterial);
        rightHighlight.position.set(0.13, 0.08, 0.45);
        headGroup.add(rightHighlight);
        
        // 眉毛 - 自然剑眉
        const browGeo = new THREE.CapsuleGeometry(0.03, 0.18, 4, 8);
        const leftBrow = new THREE.Mesh(browGeo, hairMaterial);
        leftBrow.position.set(-0.15, 0.18, 0.42);
        leftBrow.rotation.z = 0.08;
        leftBrow.rotation.x = 0.15;
        headGroup.add(leftBrow);
        
        const rightBrow = new THREE.Mesh(browGeo, hairMaterial);
        rightBrow.position.set(0.15, 0.18, 0.42);
        rightBrow.rotation.z = -0.08;
        rightBrow.rotation.x = 0.15;
        headGroup.add(rightBrow);
        
        // 嘴巴 - 自信微笑
        const mouthCurve = new THREE.TorusGeometry(0.07, 0.02, 8, 16, Math.PI);
        const mouthMaterial = new THREE.MeshStandardMaterial({ color: 0xc08080 });
        const mouth = new THREE.Mesh(mouthCurve, mouthMaterial);
        mouth.position.set(0, -0.16, 0.44);
        mouth.rotation.z = Math.PI;
        headGroup.add(mouth);

        bodyGroup.add(headGroup);

        // 3. 手臂
        function createArm(isLeft) {
            const armGroup = new THREE.Group();
            const m = isLeft ? 1 : -1;
            
            const shoulderGeo = new THREE.SphereGeometry(0.17, 16, 16);
            const shoulder = new THREE.Mesh(shoulderGeo, clothesMaterial);
            armGroup.add(shoulder);
            
            const upperArmGeo = new THREE.CylinderGeometry(0.12, 0.1, 0.5, 12);
            const upperArm = new THREE.Mesh(upperArmGeo, clothesMaterial);
            upperArm.position.y = -0.25;
            upperArm.castShadow = true;
            armGroup.add(upperArm);
            
            const elbowGeo = new THREE.SphereGeometry(0.09, 12, 12);
            const elbow = new THREE.Mesh(elbowGeo, skinMaterial);
            elbow.position.y = -0.52;
            armGroup.add(elbow);
            
            const forearmGeo = new THREE.CylinderGeometry(0.1, 0.08, 0.45, 12);
            const forearm = new THREE.Mesh(forearmGeo, skinMaterial);
            forearm.position.y = -0.75;
            forearm.castShadow = true;
            armGroup.add(forearm);
            
            const handGeo = new THREE.SphereGeometry(0.12, 12, 12);
            handGeo.scale(1, 0.7, 0.8);
            const hand = new THREE.Mesh(handGeo, skinMaterial);
            hand.position.y = -1.0;
            armGroup.add(hand);
            
            armGroup.position.set(m * 0.7, 1.15, 0);
            armGroup.rotation.z = m * 0.12;
            
            return armGroup;
        }
        
        const leftArm = createArm(true);
        const rightArm = createArm(false);
        bodyGroup.add(leftArm);
        bodyGroup.add(rightArm);

        // 4. 腿部
        function createLeg(isLeft) {
            const legGroup = new THREE.Group();
            const m = isLeft ? 1 : -1;
            
            const thighGeo = new THREE.CylinderGeometry(0.16, 0.14, 0.65, 12);
            const thigh = new THREE.Mesh(thighGeo, pantsMaterial);
            thigh.position.y = -0.32;
            thigh.castShadow = true;
            legGroup.add(thigh);
            
            const kneeGeo = new THREE.SphereGeometry(0.13, 12, 12);
            const knee = new THREE.Mesh(kneeGeo, pantsMaterial);
            knee.position.y = -0.68;
            legGroup.add(knee);
            
            const calfGeo = new THREE.CylinderGeometry(0.13, 0.11, 0.65, 12);
            const calf = new THREE.Mesh(calfGeo, pantsMaterial);
            calf.position.y = -1.05;
            calf.castShadow = true;
            legGroup.add(calf);
            
            const shoeGeo = new THREE.BoxGeometry(0.18, 0.1, 0.32);
            const shoeMaterial = new THREE.MeshStandardMaterial({ color: 0x3d3d3d });
            const shoe = new THREE.Mesh(shoeGeo, shoeMaterial);
            shoe.position.set(0, -1.42, 0.05);
            legGroup.add(shoe);
            
            legGroup.position.set(m * 0.28, 0.2, 0);
            
            return legGroup;
        }
        
        const leftLeg = createLeg(true);
        const rightLeg = createLeg(false);
        bodyGroup.add(leftLeg);
        bodyGroup.add(rightLeg);

        character.add(bodyGroup);
        scene.add(character);

        // 相机看向角色
        camera.lookAt(0, 1.2, 0);

        // 漂浮的星星
        const stars = [];
        const starGeo = new THREE.OctahedronGeometry(0.08, 0);
        const starMat = new THREE.MeshStandardMaterial({ 
            color: 0x5a9bd5, 
            emissive: 0x5a9bd5,
            emissiveIntensity: 0.4
        });
        
        for (let i = 0; i < 8; i++) {
            const star = new THREE.Mesh(starGeo, starMat);
            const angle = (i / 8) * Math.PI * 2;
            const radius = 1.8 + Math.random() * 0.5;
            star.position.set(
                Math.cos(angle) * radius,
                1.2 + Math.random() * 1.5,
                Math.sin(angle) * radius
            );
            star.userData = {
                initialY: star.position.y,
                speed: 0.5 + Math.random() * 0.5,
                offset: Math.random() * Math.PI * 2,
                rotSpeed: 0.02 + Math.random() * 0.02
            };
            scene.add(star);
            stars.push(star);
        }

        // --- 动画循环 ---
        let time = 0;
        let isBouncing = false;
        let bounceStartTime = 0;
        
        function animate() {
            requestAnimationFrame(animate);
            time += 0.016;
            
            // 呼吸动画
            const breath = Math.sin(time * 1.5) * 0.015;
            bodyGroup.scale.y = 1 + breath * 0.5;
            bodyGroup.scale.x = 1 - breath * 0.2;
            bodyGroup.scale.z = 1 - breath * 0.2;
            
            // 轻微摇摆
            character.rotation.y = Math.sin(time * 0.4) * 0.08;
            
            // 手臂摆动
            leftArm.rotation.z = 0.12 + Math.sin(time * 1.2) * 0.04;
            rightArm.rotation.z = -0.12 - Math.sin(time * 1.2 + Math.PI) * 0.04;
            
            // 头部跟随
            headGroup.rotation.y = Math.sin(time * 0.25) * 0.06;
            headGroup.rotation.x = Math.sin(time * 0.8) * 0.015;
            
            // 星星漂浮
            stars.forEach((star, i) => {
                star.position.y = star.userData.initialY + Math.sin(time * star.userData.speed + star.userData.offset) * 0.2;
                star.rotation.y += star.userData.rotSpeed;
                star.rotation.x += star.userData.rotSpeed * 0.5;
                const scale = 1 + Math.sin(time * 3 + star.userData.offset) * 0.2;
                star.scale.setScalar(scale);
            });
            
            // 优化的点击跳跃动画 - 更自然
            if (isBouncing) {
                const bounceProgress = (time - bounceStartTime) / 0.6; // 0.6秒动画
                if (bounceProgress <= 1) {
                    // 使用正弦曲线创建平滑的跳跃
                    const bounceHeight = Math.sin(bounceProgress * Math.PI) * 0.15;
                    character.position.y = bounceHeight;
                } else {
                    isBouncing = false;
                    character.position.y = 0;
                }
            } else {
                character.position.y = 0;
            }
            
            renderer.render(scene, camera);
        }
        animate();

        // 自适应窗口
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- UI 更新 ---
        const msgDiv = document.getElementById('message-bubble');
        const weatherDiv = document.getElementById('weather-tag');
        const happinessFill = document.getElementById('happiness-fill');
        const happinessVal = document.getElementById('happiness-value');
        const nightOverlay = document.getElementById('night-overlay');

        function updateUI() {
            pet.happiness = Math.max(0, Math.min(100, pet.happiness));
            happinessFill.style.width = pet.happiness + '%';
            happinessVal.innerText = Math.floor(pet.happiness);
            
            if (pet.happiness >= 80) {
                happinessFill.style.background = 'linear-gradient(90deg, #5a9bd5, #3d7ab8)';
            } else if (pet.happiness >= 50) {
                happinessFill.style.background = 'linear-gradient(90deg, #7ab8e0, #5a9bd5)';
            } else {
                happinessFill.style.background = 'linear-gradient(90deg, #a0c0d0, #7ab8e0)';
            }
        }

        function showLovePopup(x, y, text) {
            const popup = document.createElement('div');
            popup.className = 'love-popup';
            popup.innerText = text;
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1500);
        }

        async function updateWeatherAndMessage() {
            let weatherText = '晴';
            try {
                const hour = new Date().getHours();
                if (hour >= 19 || hour < 6) weatherText = '夜';
                else {
                    const rand = Math.random();
                    if (rand < 0.4) weatherText = '晴';
                    else if (rand < 0.7) weatherText = '多云';
                    else weatherText = '雨';
                }
            } catch (e) {}
            
            pet.weather = weatherText;
            const iconMap = {
                '晴': 'sun',
                '多云': 'cloud-sun',
                '雨': 'cloud-rain',
                '雪': 'snowflake',
                '雾': 'smog',
                '夜': 'moon'
            };
            weatherDiv.innerHTML = `<i class="fas fa-${iconMap[weatherText] || 'sun'}"></i> 今天 ${weatherText}`;
            
            msgDiv.innerText = getLoveMessage();
        }

        // --- 每小时掉好感度机制 ---
        function decreaseHappinessOverTime() {
            const now = Date.now();
            const lastInteraction = pet.lastInteraction || now;
            const hoursSinceInteraction = (now - lastInteraction) / (1000 * 60 * 60);
            
            if (hoursSinceInteraction >= 1) {
                const hoursPassed = Math.floor(hoursSinceInteraction);
                const decrease = hoursPassed * 5;
                pet.happiness = Math.max(0, pet.happiness - decrease);
                pet.lastInteraction = now - (hoursSinceInteraction % 1) * (1000 * 60 * 60);
                updateUI();
                saveState();
                
                if (pet.happiness < 30 && pet.happiness > 0) {
                    msgDiv.innerText = '嘿，好久不见，我想你了...';
                }
            }
        }

        setInterval(decreaseHappinessOverTime, 60000);
        decreaseHappinessOverTime();

        // --- 互动事件 ---
        let lastShake = Date.now();
        window.addEventListener('devicemotion', (e) => {
            const acc = e.accelerationIncludingGravity;
            if (!acc) return;
            const speed = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
            if (speed > 25 && (Date.now() - lastShake) > 2000) {
                lastShake = Date.now();
                pet.happiness = Math.min(100, pet.happiness + 3);
                pet.lastInteraction = Date.now();
                msgDiv.innerText = getMessage('interact', 'shake');
                
                // 摇晃动画 - 更自然
                const shakeAmount = 0.15;
                character.rotation.z = shakeAmount;
                setTimeout(() => character.rotation.z = -shakeAmount * 0.5, 150);
                setTimeout(() => character.rotation.z = shakeAmount * 0.3, 300);
                setTimeout(() => character.rotation.z = 0, 450);
                
                updateUI();
                saveState();
            }
        });

        renderer.domElement.addEventListener('click', (e) => {
            // 每次点击+1好感度
            pet.happiness = Math.min(100, pet.happiness + 1);
            pet.lastInteraction = Date.now();
            msgDiv.innerText = getLoveMessage();
            
            const rect = renderer.domElement.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            showLovePopup(x, y, '+1 ❤');
            
            // 触发自然跳跃动画
            if (!isBouncing) {
                isBouncing = true;
                bounceStartTime = time;
            }
            
            updateUI();
            saveState();
        });

        if ('getBattery' in navigator) {
            navigator.getBattery().then(battery => {
                if (battery.charging) {
                    pet.happiness = Math.min(100, pet.happiness + 2);
                    pet.lastInteraction = Date.now();
                    msgDiv.innerText = getMessage('interact', 'charge');
                    updateUI();
                    saveState();
                }
                battery.addEventListener('chargingchange', () => {
                    if (battery.charging) {
                        pet.happiness = Math.min(100, pet.happiness + 2);
                        pet.lastInteraction = Date.now();
                        msgDiv.innerText = getMessage('interact', 'charge');
                        updateUI();
                        saveState();
                    }
                });
            });
        }

        function checkNightMode() {
            const hour = new Date().getHours();
            if (hour >= 23 || hour < 6) {
                nightOverlay.style.opacity = '0.6';
                msgDiv.innerText = '晚安，好梦，明天见～';
                leftEye.scale.y = 0.1;
                rightEye.scale.y = 0.1;
            } else {
                nightOverlay.style.opacity = '0';
                leftEye.scale.y = 1;
                rightEye.scale.y = 1;
            }
        }
        setInterval(checkNightMode, 60000);
        checkNightMode();

        function saveState() {
            pet.lastVisit = Date.now();
            localStorage.setItem('weatherPet3d_v2', JSON.stringify(pet));
        }

        async function requestNotificationPermission() {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'granted') {
                setupBeforeUnload();
            } else if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    document.getElementById('permission-guide').style.display = 'none';
                    setupBeforeUnload();
                }
            } else {
                document.getElementById('permission-guide').style.display = 'block';
            }
        }

        function setupBeforeUnload() {
            window.addEventListener('beforeunload', () => {
                if (Notification.permission === 'granted') {
                    setTimeout(() => {
                        new Notification('你的小宠在想你', {
                            body: '快回来找我，我想你了～',
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#5a9bd5"/><circle cx="30" cy="40" r="8" fill="white"/><circle cx="70" cy="40" r="8" fill="white"/></svg>',
                            tag: 'pet-reminder'
                        });
                    }, 30 * 1000);
                }
            });
        }

        if (isIOS) {
            setTimeout(() => requestNotificationPermission(), 2000);
        }

        document.getElementById('request-permission-btn')?.addEventListener('click', () => {
            requestNotificationPermission();
        });

        updateWeatherAndMessage();
        setInterval(updateWeatherAndMessage, 30 * 60 * 1000);
        updateUI();

        // 隐藏loading
        setTimeout(() => {
            document.getElementById('loading').style.opacity = '0';
            setTimeout(() => document.getElementById('loading').remove(), 500);
        }, 1000);

        // 注册Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker 注册成功:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker 注册失败:', error);
                    });
            });
        }
    </script>
</body>
</html>
